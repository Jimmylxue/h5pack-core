"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),s=require("os"),a=require("fs/promises"),t=require("fs"),o=require("ora"),n=require("child_process"),r=require("chalk"),i=require("xml2js");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=c(o),d=c(r),p=c(i);let u;function w(){u=require(e.resolve(process.cwd(),"h5pack.json")),u.registry=u.registry||"github",u.buildFormat=u.buildFormat||"apk"}let f=l.default(),m=l.default();function h(e){u.log&&m.info(e)}async function g(e){try{await a.rm(e,{recursive:!0,force:!0}),f.succeed("üôà Success clear cache"),console.log("success clear data")}catch(s){f.fail(`üôà remove temp dir fail in ${e}`)}}function y(e){return t.existsSync(e)}function v(s,a){t.existsSync(a)||t.mkdirSync(a,{recursive:!0});const o=t.readdirSync(s);for(const n of o){const o=e.join(s,n),r=e.join(a,n);t.statSync(o).isDirectory()?v(o,r):t.copyFileSync(o,r)}}const A={github:"https://github.com/Jimmylxue/h5pack-native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},E={code:1e4,message:"cloneÂºÇÂ∏∏ÔºåÊ£ÄÊü•ÁΩëÁªú‰ª£ÁêÜÔºåÊàñÈÖçÁΩÆ‰∏∫ÂõΩÂÜÖ‰ª£ÁêÜ"},P={code:10001,message:"Ëé∑ÂèñÈùôÊÄÅËµÑÊ∫êÂºÇÂ∏∏ÔºåÊ£ÄÊü•h5pack.json‰∏≠entryÈÖçÁΩÆ"},O={code:10002,message:"yarn installÂºÇÂ∏∏ÔºåÊ£ÄÊü•ÁΩëÁªú‰ª£ÁêÜÔºåÊàñÈÖçÁΩÆ‰∏∫ÂõΩÂÜÖ‰ª£ÁêÜ"},k={code:10003,message:".envÊñá‰ª∂ÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠nameÈÖçÁΩÆ"},_={code:10004,message:"splashÂêØÂä®È°µÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠splashÁõ∏ÂÖ≥ÈÖçÁΩÆ"},S={code:10005,message:"release APPÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÂÆâÂçìÊâìÂåÖÁéØÂ¢É"},D={code:10006,message:"copy releaseÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠outputÈÖçÁΩÆ"},C={code:10007,message:"appLogoÂêØÂä®È°µÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠logoÁõ∏ÂÖ≥ÈÖçÁΩÆ"},R={code:10008,message:"nativePermissionÈÖçÁΩÆÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠nativePermissionÁõ∏ÂÖ≥ÈÖçÁΩÆ"},b={code:10011,message:"devÁéØÂ¢ÉÂêØÂä®ÂºÇÂ∏∏"};function $(e,s,a=[],t){return new Promise(((t,o)=>{const r=s+" "+a.join(" "),i=n.spawn(s,a,{cwd:e});i.stdout.on("data",(e=>{h(`${r} stdout: ${e}`)})),i.stderr.on("data",(e=>{h(`${r} stderr: ${e}`)})),i.on("close",(e=>{0!==e?o(new Error(`${r} exited with code ${e}`)):t(!0)}))})).catch((e=>{t?.(e.message)}))}class I extends Error{failMessage=void 0;originErrorMessage;constructor(e,s){super(),this.failMessage=e,this.originErrorMessage=s}}const N=require("properties-parser");async function j(s,t=!1,o){const n=`\n  APP_NAME=${u.name||"H5Pack"}\n  APP_ANDROID_VERSION=${u.versionName||"1.0.0"}\n  APP_ANDROID_VERSION_CODE=${u.versionCode||"1"}\t\n  APP_PACKAGE_NAME=${u.packageName||"com.h5pack.native"}\t\t\n  APP_WEBVIEW_DEV_ENABLED=${t?"true":"false"}\n  APP_WEBVIEW_DEV_PORT=${o||"9996"}\n  `;try{await a.writeFile(e.resolve(s,".env"),n,"utf-8")}catch(e){throw new I(k,e.message||"write env file error")}}async function T(s){if(u.splash)try{const t=e.basename(u.splash),o=e.resolve(process.cwd(),u.splash),n=e.resolve(s,`./public/splash/${t}`);if(!y(o))throw new Error("packConfig.splash is not a available path");await a.copyFile(o,n),await $(s,"yarn",["react-native","generate-bootsplash",e.resolve(s,`./public/splash/${t}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new I(_,e.message)}}async function x(s){if(u.logo)try{const t=e.basename(u.logo),o=e.resolve(process.cwd(),u.logo),n=e.resolve(s,`./public/logo/${t}`);y(o)&&(await a.copyFile(o,n),await $(s,"npx",["iconkits",`--input=./public/logo/${t}`],(e=>{throw new Error(e)})))}catch(e){throw new I(C,e.message)}}async function M(s){await j(s),await T(s),await x(s),await function(s){return new Promise((async(t,o)=>{if(!(u.keystorePath&&u.storePassword&&u.keyAlias&&u.keyPassword))return void t(!0);const n=e.basename(u.keystorePath),r=e.resolve(process.cwd(),u.keystorePath);if(!y(r))throw new Error("keystorePath is not a available path");const i=e.resolve(s,"./android/app/"),c=e.resolve(i,n);await a.copyFile(r,c);const l=e.resolve(s,"./android/gradle.properties"),d=N.createEditor(l);d.set("H5PACK_APP_KEY_STORE_FILE",n),d.set("H5PACK_APP_KEY_STORE_PASSWORD",u.storePassword),d.set("H5PACK_APP_KEY_ALIAS",u.keyAlias),d.set("H5PACK_APP_KEY_PASSWORD",u.keyPassword),d.save(l,(e=>{e?(console.error("‚ùå ‰øùÂ≠òÊñá‰ª∂Êó∂Âá∫Èîô:",e),o()):(console.log("‚úÖ gradle.properties Êõ¥Êñ∞ÊàêÂäü„ÄÇ"),t(!0))}))}))}(s),f.stop(),f.succeed("‚úÖ Custom Config Success")}const H="h5pack-native/android/app/src/main/AndroidManifest.xml",L={CAMERA:["android.permission.CAMERA","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],cameraWithAudio:["android.permission.CAMERA","android.permission.RECORD_AUDIO","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],LOCATION:["android.permission.ACCESS_FINE_LOCATION","android.permission.ACCESS_COARSE_LOCATION"],microphone:["android.permission.RECORD_AUDIO"],storage:["android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],RECORD_AUDIO:["android.permission.RECORD_AUDIO"]};function F(){return e.join(exports.tempDir,H)}async function q(e){const s=t.readFileSync(F(),"utf8"),a=new p.default.Parser,o=await a.parseStringPromise(s);L[e].forEach((e=>o.manifest["uses-permission"].push({$:{"android:name":e}})));let n=new p.default.Builder({renderOpts:{pretty:!0,indent:"  "}}).buildObject(o);var r;n=n.replace(/<\?xml[^?>]*\?>\s*/i,""),r=n,t.writeFileSync(F(),r,"utf8")}async function W(){await q("CAMERA"),f.succeed("‚úÖ Handle Native Permission CAMERA SUCCESS!")}async function K(){await q("LOCATION"),f.succeed("‚úÖ Handle Native Permission LOCATION SUCCESS!")}async function U(){await q("RECORD_AUDIO"),f.succeed("‚úÖ Handle Native Permission RECORD_AUDIO SUCCESS!")}const V=["CAMERA","LOCATION","RECORD_AUDIO"];async function G(s,a){try{const t=e.resolve(process.cwd(),u.entry);if(!y(t))return void a("packConfig.entry is not a available path");const o=e.join(s,"./h5pack-native/public/webview/dist");await v(t,o)}catch(e){a(e.message||"packConfig.entry is not a available path")}}async function J(s){const a=e.join(s,"./h5pack-native");f.start("üö© Download Source ......"),await $(s,"git",["clone",A[u.registry],a],(e=>{throw f.stop(),new I(E,e)})),f.succeed("‚úÖ download success!"),await G(s,(e=>{throw new I(P,e)})),f.start("üö© Handle Custom Permission ......"),await async function(){const e=u.nativePermission;if(!e)return void f.info("‚úÖ Êó†ÁâπÊÆäÊùÉÈôêÈÖçÁΩÆ ......");if(!Array.isArray(e))throw f.stop(),new I(R,e);if(Array.isArray(e)&&!e.every((e=>V.includes(e))))throw f.stop(),new I(R,JSON.stringify(e));const s=[...new Set(e)];for(const e of s)switch(e){case"CAMERA":await W();break;case"LOCATION":await K();break;case"RECORD_AUDIO":await U()}}(),f.start("üö© Install Dependencies ......"),await $(a,"yarn",[],(e=>{throw f.stop(),new I(O,e)})),f.succeed("‚úÖ Dependencies Installed!"),f.start("üö© Handle Custom Config ......"),await M(a),f.succeed("‚úÖ Handle Success!"),f.start("üòä Building App ......");const o="aab"===u.buildFormat?"release:aab":"release";await $(a,"yarn",[o],(e=>{throw f.stop(),new I(S,e)})),f.stop(),f.start("‚úÖ building Success ......"),f.start("üòä Generate Apk ......"),await async function(s,a){try{const a=e.resolve(process.cwd(),u.output||"./");if(!y(a))throw new Error("packConfig.output is not a available path");const o="aab"===u.buildFormat,n=o?e.join(s,"./h5pack-native/android/app/build/outputs/bundle/release/app-release.aab"):e.join(s,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),r=o?"app-release.aab":"app-release.apk";await t.promises.copyFile(n,e.resolve(a,r))}catch(e){a(e.message||"packConfig.output is not a available path")}}(s,(e=>{throw new I(D,e)})),f.stop(),f.succeed("üéâ Packaging completed !!! üéâ")}function B(e){return new Promise(((s,a)=>{n.exec(e,((e,t,o)=>{e?a(o||e.message):s(t||o)}))}))}async function X(){const s=l.default("Generating h5pack.json...").start();try{const o=e.resolve(process.cwd(),"h5pack.json");try{return await a.access(o,t.constants.F_OK),s.info("h5pack.json already exists"),void s.stop()}catch{}await a.writeFile(o,JSON.stringify({entry:"./dist",name:"H5PackApp",output:"./",registry:"github",buildFormat:"apk",packageName:"com.h5pack.native",versionName:"1.0.0",versionCode:"1",logo:"",splash:"",nativePermission:["CAMERA","LOCATION","RECORD_AUDIO"],keystorePath:"",storePassword:"",keyAlias:"",keyPassword:"",log:!1},null,2),"utf-8"),s.succeed("h5pack.json created")}catch(e){throw s.fail(e.message||"create h5pack.json failed"),e}}function Y(s){const a=e.resolve(process.cwd(),u.entry);y(a)&&(console.log(d.default.cyan(`üëÄ Watching for changes in ${a} ......`)),t.watch(a,{recursive:!0},((o,n)=>{if(!n)return;const r=e.resolve(a,n);try{console.log(d.default.yellow(`üîÑ  Syncing change ${r} ......`)),function(s,a,o){const n=e.relative(o,a),r=e.join(s,"./h5pack-native/public/webview/dist"),i=e.join(r,n),c=e.dirname(i);t.existsSync(c)||t.mkdirSync(c,{recursive:!0}),t.existsSync(a)?t.copyFileSync(a,i):t.existsSync(i)&&t.unlinkSync(i)}(s,r,a),console.log(d.default.green("‚úÖ Sync success!"))}catch(e){console.log(d.default.red(`‚ùå Sync failed: ${e.message||e}`))}})))}async function z(s,a){const t=e.join(s,"./h5pack-native");console.log(d.default.cyan("üö© Prepare Native Source (Dev) ......")),y(t)?console.log(d.default.cyan("‚úÖ use local h5pack-native ......")):(await $(s,"git",["clone",A[u.registry],t],(e=>{throw console.log(d.default.red(`‚ùå Download failed: ${e}`)),new I(E,e)})),console.log(d.default.green("‚úÖ download success!"))),await $(t,"yarn",[],(e=>{throw f.stop(),new I(O,e)}));a.devPort||a.reversePort?(a.devPort&&(await j(t,!0,a.devPort),console.log(d.default.cyan(`‚öôÔ∏è  Inject DEV env: APP_WEBVIEW_DEV_ENABLED=true, PORT=${a.devPort}`))),a.reversePort&&(console.log(d.default.cyan(`üîÅ adb reverse tcp:${a.reversePort} -> host tcp:${a.reversePort}`)),await $(process.cwd(),"adb",["reverse",`tcp:${a.reversePort}`,`tcp:${a.reversePort}`],(e=>{console.log(d.default.red(`‚ùå adb reverse failed: ${e}`))}))),await async function(e){try{await $(e,"yarn",["android"],(e=>{throw new Error(e)}))}catch(e){throw new I(b,e.message)}}(t)):(await G(s,(e=>{throw new I(P,e)})),a.watch&&Y(s),a.start&&(console.log(d.default.cyan("üö© Start Local Server ......")),await async function(e){try{await $(e,"yarn",["dev:android:local"],(e=>{throw new Error(e)}))}catch(e){throw new I(b,e.message)}}(t))),f.start("üö© Handle Dev Custom Config ......"),await async function(e){await T(e),await x(e),f.stop(),f.succeed("‚úÖ Dev Custom Config Success")}(t),f.succeed("‚úÖ Handle Success!"),f.start("üö© Install Dependencies ......"),await $(t,"yarn",[],(e=>{throw f.stop(),new I(O,e)})),f.succeed("‚úÖ Dependencies Installed!"),f.succeed("üéâ Dev project is ready. Open h5pack-native/android in Android Studio or cd h5pack-native && run yarn dev:android:local")}async function Q(){try{const a=s.tmpdir();exports.tempDir=e.join(a,"app-build"),await t.promises.mkdir(exports.tempDir,{recursive:!0}),await J(exports.tempDir)}catch(e){!function(e){const s=l.default();s.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),s.clear()}(e),g(exports.tempDir)}}exports.tempDir=void 0;process.on("SIGINT",(async()=>{exports.tempDir&&await g(exports.tempDir),process.exit()})),exports.default=async()=>{const e=process.argv.slice(2),s=e[0];if("doctor"!==s)if("init"!==s)if("dev"!==s)w(),Q();else{w();const s=e.includes("--watch"),a=e.includes("--start"),t=e.find((e=>e.startsWith("--server="))),o=e.find((e=>e.startsWith("--reverse=")));let n,r;if(t){const e=t.split("=")[1];if(/^https?:\/\//.test(e))try{const s=new URL(e);n=s.port?parseInt(s.port,10):"https:"===s.protocol?443:80}catch{}else/^\d+$/.test(e)&&(n=parseInt(e,10))}if(o){const e=o.split("=")[1];/^\d+$/.test(e)&&(r=parseInt(e,10))}await z(process.cwd(),{watch:s,start:a,devPort:n,reversePort:r})}else await X();else await async function(){console.log(d.default.bold.blue("\nüè• h5pack Environment Doctor\n"));const e=[{name:"Node.js",command:"node -v",required:!0},{name:"Git",command:"git --version",required:!0},{name:"Java (JDK)",command:"javac -version",required:!0,hint:"Install JDK 11+ and set JAVA_HOME."},{name:"Android SDK (adb)",command:"adb version",required:!1,hint:"Add Android SDK platform-tools to PATH."}];let s=!1;for(const a of e){const e=l.default(`Checking ${a.name}...`).start();try{const s=(await B(a.command)).trim().split("\n")[0];e.succeed(`${a.name}: ${d.default.green(s)}`)}catch(t){e.fail(`${a.name} check failed`),a.required?(s=!0,console.log(d.default.red(`   Error: ${t}`)),a.hint&&console.log(d.default.yellow(`   Hint: ${a.hint}`))):(console.log(d.default.gray(`   Warning: ${t}`)),a.hint&&console.log(d.default.gray(`   Hint: ${a.hint}`)))}}const a=["JAVA_HOME","ANDROID_HOME"];console.log(d.default.bold.blue("\nEnvironment Variables:"));for(const e of a)process.env[e]?console.log(`‚úÖ ${e} = ${process.env[e]}`):(console.log(`‚ùå ${e} is not set`),"ANDROID_HOME"!==e&&"JAVA_HOME"!==e||(s=!0));console.log("\n"),s?(console.log(d.default.red("‚ùå Missing environment requirements.")),process.exit(1)):console.log(d.default.green("‚úÖ Environment looks good"))}()};
