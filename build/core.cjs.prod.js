"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),s=require("os"),a=require("fs/promises"),o=require("fs"),t=require("ora"),r=require("child_process"),n=require("chalk"),i=require("xml2js");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=c(t),d=c(n),p=c(i);let u;let m=l.default(),f=l.default();function w(e){u.log&&f.info(e)}async function A(e){try{await a.rm(e,{recursive:!0,force:!0}),m.succeed("üôà Success clear cache"),console.log("success clear data")}catch(s){m.fail(`üôà remove temp dir fail in ${e}`)}}function g(e){return o.existsSync(e)}function h(s,a){o.existsSync(a)||o.mkdirSync(a,{recursive:!0});const t=o.readdirSync(s);for(const r of t){const t=e.join(s,r),n=e.join(a,r);o.statSync(t).isDirectory()?h(t,n):o.copyFileSync(t,n)}}const y={github:"https://github.com/Jimmylxue/h5pack-native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},E={code:1e4,message:"cloneÂºÇÂ∏∏ÔºåÊ£ÄÊü•ÁΩëÁªú‰ª£ÁêÜÔºåÊàñÈÖçÁΩÆ‰∏∫ÂõΩÂÜÖ‰ª£ÁêÜ"},v={code:10001,message:"Ëé∑ÂèñÈùôÊÄÅËµÑÊ∫êÂºÇÂ∏∏ÔºåÊ£ÄÊü•h5pack.json‰∏≠entryÈÖçÁΩÆ"},O={code:10002,message:"yarn installÂºÇÂ∏∏ÔºåÊ£ÄÊü•ÁΩëÁªú‰ª£ÁêÜÔºåÊàñÈÖçÁΩÆ‰∏∫ÂõΩÂÜÖ‰ª£ÁêÜ"},k={code:10003,message:".envÊñá‰ª∂ÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠nameÈÖçÁΩÆ"},_={code:10004,message:"splashÂêØÂä®È°µÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠splashÁõ∏ÂÖ≥ÈÖçÁΩÆ"},C={code:10005,message:"release APPÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÂÆâÂçìÊâìÂåÖÁéØÂ¢É"},R={code:10006,message:"copy releaseÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠outputÈÖçÁΩÆ"},P={code:10007,message:"appLogoÂêØÂä®È°µÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠logoÁõ∏ÂÖ≥ÈÖçÁΩÆ"},D={code:10008,message:"nativePermissionÈÖçÁΩÆÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠nativePermissionÁõ∏ÂÖ≥ÈÖçÁΩÆ"};function S(e,s,a=[],o){return new Promise(((o,t)=>{const n=s+" "+a.join(" "),i=r.spawn(s,a,{cwd:e});i.stdout.on("data",(e=>{w(`${n} stdout: ${e}`)})),i.stderr.on("data",(e=>{w(`${n} stderr: ${e}`)})),i.on("close",(e=>{0!==e?t(new Error(`${n} exited with code ${e}`)):o(!0)}))})).catch((e=>{o?.(e.message)}))}class b extends Error{failMessage=void 0;originErrorMessage;constructor(e,s){super(),this.failMessage=e,this.originErrorMessage=s}}const I=require("properties-parser");async function N(s){await async function(s){const o=`\n  APP_NAME=${u.name||"H5Pack"}\n  APP_ANDROID_VERSION=${u.versionName||"1.0.0"}\n  APP_ANDROID_VERSION_CODE=${u.versionCode||"1"}\t\n  APP_PACKAGE_NAME=${u.packageName||"com.h5pack.native"}\t\n  `;try{await a.writeFile(e.resolve(s,".env"),o,"utf-8")}catch(e){throw new b(k,e.message||"write env file error")}}(s),await async function(s){if(u.splash)try{const o=e.basename(u.splash),t=e.resolve(process.cwd(),u.splash),r=e.resolve(s,`./public/splash/${o}`);if(!g(t))throw new Error("packConfig.splash is not a available path");await a.copyFile(t,r),await S(s,"yarn",["react-native","generate-bootsplash",e.resolve(s,`./public/splash/${o}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new b(_,e.message)}}(s),await async function(s){if(u.logo)try{const o=e.basename(u.logo),t=e.resolve(process.cwd(),u.logo),r=e.resolve(s,`./public/logo/${o}`);g(t)&&(await a.copyFile(t,r),await S(s,"npx",["iconkits",`--input=./public/logo/${o}`],(e=>{throw new Error(e)})))}catch(e){throw new b(P,e.message)}}(s),await function(s){return new Promise((async(o,t)=>{if(!(u.keystorePath&&u.storePassword&&u.keyAlias&&u.keyPassword))return void o(!0);const r=e.basename(u.keystorePath),n=e.resolve(process.cwd(),u.keystorePath);if(!g(n))throw new Error("keystorePath is not a available path");const i=e.resolve(s,"./android/app/"),c=e.resolve(i,r);await a.copyFile(n,c);const l=e.resolve(s,"./android/gradle.properties"),d=I.createEditor(l);d.set("H5PACK_APP_KEY_STORE_FILE",r),d.set("H5PACK_APP_KEY_STORE_PASSWORD",u.storePassword),d.set("H5PACK_APP_KEY_ALIAS",u.keyAlias),d.set("H5PACK_APP_KEY_PASSWORD",u.keyPassword),d.save(l,(e=>{e?(console.error("‚ùå ‰øùÂ≠òÊñá‰ª∂Êó∂Âá∫Èîô:",e),t()):(console.log("‚úÖ gradle.properties Êõ¥Êñ∞ÊàêÂäü„ÄÇ"),o(!0))}))}))}(s),m.stop(),m.succeed("‚úÖ Custom Config Success")}const $="h5pack-native/android/app/src/main/AndroidManifest.xml",j={CAMERA:["android.permission.CAMERA","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],cameraWithAudio:["android.permission.CAMERA","android.permission.RECORD_AUDIO","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],LOCATION:["android.permission.ACCESS_FINE_LOCATION","android.permission.ACCESS_COARSE_LOCATION"],microphone:["android.permission.RECORD_AUDIO"],storage:["android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],RECORD_AUDIO:["android.permission.RECORD_AUDIO"]};function T(){return e.join(exports.tempDir,$)}async function x(e){const s=o.readFileSync(T(),"utf8"),a=new p.default.Parser,t=await a.parseStringPromise(s);j[e].forEach((e=>t.manifest["uses-permission"].push({$:{"android:name":e}})));let r=new p.default.Builder({renderOpts:{pretty:!0,indent:"  "}}).buildObject(t);var n;r=r.replace(/<\?xml[^?>]*\?>\s*/i,""),n=r,o.writeFileSync(T(),n,"utf8")}async function M(){await x("CAMERA"),m.succeed("‚úÖ Handle Native Permission CAMERA SUCCESS!")}async function H(){await x("LOCATION"),m.succeed("‚úÖ Handle Native Permission LOCATION SUCCESS!")}async function F(){await x("RECORD_AUDIO"),m.succeed("‚úÖ Handle Native Permission RECORD_AUDIO SUCCESS!")}const L=["CAMERA","LOCATION","RECORD_AUDIO"];async function q(s,a){try{const o=e.resolve(process.cwd(),u.entry);if(!g(o))return void a("packConfig.entry is not a available path");const t=e.join(s,"./h5pack-native/public/webview/dist");await h(o,t)}catch(e){a(e.message||"packConfig.entry is not a available path")}}async function K(s){const a=e.join(s,"./h5pack-native");m.start("üö© Download Source ......"),await S(s,"git",["clone",y[u.registry],a],(e=>{throw m.stop(),new b(E,e)})),m.succeed("‚úÖ download success!"),await q(s,(e=>{throw new b(v,e)})),m.start("üö© Handle Custom Permission ......"),await async function(){const e=u.nativePermission;if(!e)return void m.info("‚úÖ Êó†ÁâπÊÆäÊùÉÈôêÈÖçÁΩÆ ......");if(!Array.isArray(e))throw m.stop(),new b(D,e);if(Array.isArray(e)&&!e.every((e=>L.includes(e))))throw m.stop(),new b(D,JSON.stringify(e));const s=[...new Set(e)];for(const e of s)switch(e){case"CAMERA":await M();break;case"LOCATION":await H();break;case"RECORD_AUDIO":await F()}}(),m.start("üö© Install Dependencies ......"),await S(a,"yarn",[],(e=>{throw m.stop(),new b(O,e)})),m.succeed("‚úÖ Dependencies Installed!"),m.start("üö© Handle Custom Config ......"),await N(a),m.succeed("‚úÖ Handle Success!"),m.start("üòä Building App ......");const t="aab"===u.buildFormat?"release:aab":"release";await S(a,"yarn",[t],(e=>{throw m.stop(),new b(C,e)})),m.stop(),m.start("‚úÖ building Success ......"),m.start("üòä Generate Apk ......"),await async function(s,a){try{const a=e.resolve(process.cwd(),u.output||"./");if(!g(a))throw new Error("packConfig.output is not a available path");const t="aab"===u.buildFormat,r=t?e.join(s,"./h5pack-native/android/app/build/outputs/bundle/release/app-release.aab"):e.join(s,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),n=t?"app-release.aab":"app-release.apk";await o.promises.copyFile(r,e.resolve(a,n))}catch(e){a(e.message||"packConfig.output is not a available path")}}(s,(e=>{throw new b(R,e)})),m.stop(),m.succeed("üéâ Packaging completed !!! üéâ")}function U(e){return new Promise(((s,a)=>{r.exec(e,((e,o,t)=>{e?a(t||e.message):s(o||t)}))}))}async function G(){const s=l.default("Generating h5pack.json...").start();try{const t=e.resolve(process.cwd(),"h5pack.json");try{return await a.access(t,o.constants.F_OK),s.info("h5pack.json already exists"),void s.stop()}catch{}await a.writeFile(t,JSON.stringify({entry:"./dist",name:"H5PackApp",output:"./",registry:"github",buildFormat:"apk",packageName:"com.h5pack.native",versionName:"1.0.0",versionCode:"1",logo:"",splash:"",nativePermission:["CAMERA","LOCATION","RECORD_AUDIO"],keystorePath:"",storePassword:"",keyAlias:"",keyPassword:"",log:!1},null,2),"utf-8"),s.succeed("h5pack.json created")}catch(e){throw s.fail(e.message||"create h5pack.json failed"),e}}async function J(){try{const a=s.tmpdir();exports.tempDir=e.join(a,"app-build"),await o.promises.mkdir(exports.tempDir,{recursive:!0}),await K(exports.tempDir)}catch(e){!function(e){const s=l.default();s.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),s.clear()}(e),A(exports.tempDir)}}exports.tempDir=void 0;process.on("SIGINT",(async()=>{exports.tempDir&&await A(exports.tempDir),process.exit()})),exports.default=async()=>{const s=process.argv.slice(2)[0];"doctor"!==s?"init"!==s?(u=require(e.resolve(process.cwd(),"h5pack.json")),u.registry=u.registry||"github",u.buildFormat=u.buildFormat||"apk",J()):await G():await async function(){console.log(d.default.bold.blue("\nüè• h5pack Environment Doctor\n"));const e=[{name:"Node.js",command:"node -v",required:!0},{name:"Git",command:"git --version",required:!0},{name:"Java (JDK)",command:"javac -version",required:!0,hint:"Install JDK 11+ and set JAVA_HOME."},{name:"Android SDK (adb)",command:"adb version",required:!1,hint:"Add Android SDK platform-tools to PATH."}];let s=!1;for(const a of e){const e=l.default(`Checking ${a.name}...`).start();try{const s=(await U(a.command)).trim().split("\n")[0];e.succeed(`${a.name}: ${d.default.green(s)}`)}catch(o){e.fail(`${a.name} check failed`),a.required?(s=!0,console.log(d.default.red(`   Error: ${o}`)),a.hint&&console.log(d.default.yellow(`   Hint: ${a.hint}`))):(console.log(d.default.gray(`   Warning: ${o}`)),a.hint&&console.log(d.default.gray(`   Hint: ${a.hint}`)))}}const a=["JAVA_HOME","ANDROID_HOME"];console.log(d.default.bold.blue("\nEnvironment Variables:"));for(const e of a)process.env[e]?console.log(`‚úÖ ${e} = ${process.env[e]}`):(console.log(`‚ùå ${e} is not set`),"ANDROID_HOME"!==e&&"JAVA_HOME"!==e||(s=!0));console.log("\n"),s?(console.log(d.default.red("‚ùå Missing environment requirements.")),process.exit(1)):console.log(d.default.green("‚úÖ Environment looks good"))}()};
