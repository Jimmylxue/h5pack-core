"use strict";var e=require("path"),o=require("os"),s=require("fs/promises"),r=require("fs"),n=require("child_process");function a(e){return r.existsSync(e)}function c(o,s){r.existsSync(s)||r.mkdirSync(s,{recursive:!0});const n=r.readdirSync(o);for(const a of n){const n=e.join(o,a),t=e.join(s,a);r.statSync(n).isDirectory()?c(n,t):r.copyFileSync(n,t)}}const t="https://github.com/Jimmylxue/h5pack-native.git";function i(e,o,s=[]){return new Promise(((r,a)=>{console.log(`${o} ${s.join(" ")} 中...... in`,e);const c=n.spawn(o,s,{cwd:e});c.stdout.on("data",(e=>{console.log(`yarn stdout: ${e}`)})),c.stderr.on("data",(e=>{console.error(`yarn stderr: ${e}`)})),c.on("close",(e=>{0!==e?a(new Error(`yarn process exited with code ${e}`)):r(!0)}))}))}class l extends Error{}async function p(o,r){await async function(o,r){const n=`\n  APP_NAME=${o.name||"H5Pack"}\n  `;try{await s.writeFile(e.resolve(r,".env"),n,"utf-8")}catch(e){console.error("write env file error",e)}}(o,r),await async function(o,r){if(!o.splash)return;const n=e.basename(o.splash),c=e.resolve(process.cwd(),o.splash),t=e.resolve(r,`./public/splash/${n}`);if(!a(c))throw new l("splash path error");await s.copyFile(c,t),console.log("splash copy Success"),await i(r,"yarn",["react-native","generate-bootsplash",e.resolve(r,`./public/splash/${n}`),"--platforms=android"]),console.log("splash generate Success")}(o,r)}async function u(o,s){console.log("rootDir",s);const n=e.join(s,"./h5pack-native");await i(s,"git",["clone",t,n]);const l=e.resolve(process.cwd(),o.entry);a(l)||console.error("路径不正确，请检查配置");const u=e.join(s,"./h5pack-native/public/webview/dist");await c(l,u),await i(n,"yarn"),await p(o,n),await i(n,"yarn",["release"]),await async function(o){await r.promises.copyFile(e.join(o,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),"app-release.apk")}(s),console.log("打包完成")}let d;async function w(){console.log("pack",d);const n=o.tmpdir(),a=e.join(n,"app-build");await r.promises.mkdir(a,{recursive:!0}),console.log("tempDir",a),await u(d,a),async function(e){try{await s.rm(e,{recursive:!0,force:!0}),console.log("success clear data")}catch(o){console.error("remove temp dir fail in ",e)}}(a)}console.log("hello world");module.exports=()=>{d=require(e.resolve(process.cwd(),"h5pack.json")),w()};
