"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),s=require("os"),a=require("fs/promises"),t=require("fs"),i=require("ora"),o=require("child_process"),r=require("xml2js");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=n(i),p=n(r);let d;let l=c.default(),u=c.default();function m(e){d.log&&u.info(e)}async function w(e){try{await a.rm(e,{recursive:!0,force:!0}),l.succeed("ðŸ™ˆ Success clear cache"),console.log("success clear data")}catch(s){l.fail(`ðŸ™ˆ remove temp dir fail in ${e}`)}}function f(e){return t.existsSync(e)}function h(s,a){t.existsSync(a)||t.mkdirSync(a,{recursive:!0});const i=t.readdirSync(s);for(const o of i){const i=e.join(s,o),r=e.join(a,o);t.statSync(i).isDirectory()?h(i,r):t.copyFileSync(i,r)}}const g={github:"https://github.com/Jimmylxue/h5pack-native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},y={code:1e4,message:"cloneå¼‚å¸¸ï¼Œæ£€æŸ¥ç½‘ç»œä»£ç†ï¼Œæˆ–é…ç½®ä¸ºå›½å†…ä»£ç†"},A={code:10001,message:"èŽ·å–é™æ€èµ„æºå¼‚å¸¸ï¼Œæ£€æŸ¥h5pack.jsonä¸­entryé…ç½®"},E={code:10003,message:".envæ–‡ä»¶ç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­nameé…ç½®"},v={code:10004,message:"splashå¯åŠ¨é¡µç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­splashç›¸å…³é…ç½®"},S={code:10005,message:"release APPå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥å®‰å“æ‰“åŒ…çŽ¯å¢ƒ"},C={code:10006,message:"copy releaseå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­outputé…ç½®"},R={code:10007,message:"appLogoå¯åŠ¨é¡µç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­logoç›¸å…³é…ç½®"},k={code:10008,message:"nativePermissioné…ç½®å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­nativePermissionç›¸å…³é…ç½®"};function b(e,s,a=[],t){return new Promise(((t,i)=>{const r=s+" "+a.join(" "),n=o.spawn(s,a,{cwd:e});n.stdout.on("data",(e=>{m(`${r} stdout: ${e}`)})),n.stderr.on("data",(e=>{m(`${r} stderr: ${e}`)})),n.on("close",(e=>{0!==e?i(new Error(`${r} exited with code ${e}`)):t(!0)}))})).catch((e=>{t?.(e.message)}))}class O extends Error{failMessage=void 0;originErrorMessage;constructor(e,s){super(),this.failMessage=e,this.originErrorMessage=s}}async function _(s){await async function(s){const t=`\n  APP_NAME=${d.name||"H5Pack"}\n  `;try{await a.writeFile(e.resolve(s,".env"),t,"utf-8")}catch(e){throw new O(E,e.message||"write env file error")}}(s),await async function(s){if(d.splash)try{const t=e.basename(d.splash),i=e.resolve(process.cwd(),d.splash),o=e.resolve(s,`./public/splash/${t}`);if(!f(i))throw new Error("packConfig.splash is not a available path");await a.copyFile(i,o),await b(s,"yarn",["react-native","generate-bootsplash",e.resolve(s,`./public/splash/${t}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new O(v,e.message)}}(s),await async function(s){if(d.logo)try{const t=e.basename(d.logo),i=e.resolve(process.cwd(),d.logo),o=e.resolve(s,`./public/logo/${t}`);f(i)&&(await a.copyFile(i,o),await b(s,"npx",["iconkits",`--input=./public/logo/${t}`],(e=>{throw new Error(e)})))}catch(e){throw new O(R,e.message)}}(s),l.stop(),l.succeed("âœ… Custom Config Success")}const x="h5pack-native/android/app/src/main/AndroidManifest.xml",j={CAMERA:["android.permission.CAMERA","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],cameraWithAudio:["android.permission.CAMERA","android.permission.RECORD_AUDIO","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],LOCATION:["android.permission.ACCESS_FINE_LOCATION","android.permission.ACCESS_COARSE_LOCATION"],microphone:["android.permission.RECORD_AUDIO"],storage:["android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"]};function T(){return e.join(exports.tempDir,x)}async function D(e){const s=t.readFileSync(T(),"utf8"),a=new p.default.Parser,i=await a.parseStringPromise(s);j.CAMERA.forEach((e=>i.manifest["uses-permission"].push({$:{"android:name":e}})));let o=new p.default.Builder({renderOpts:{pretty:!0,indent:"  "}}).buildObject(i);var r;o=o.replace(/<\?xml[^?>]*\?>\s*/i,""),r=o,t.writeFileSync(T(),r,"utf8")}async function M(){await D(),l.succeed("âœ… Handle Nat Permission CAMERA SUCCESS!")}const $=["CAMERA","LOCATION"];async function N(s,a){try{const t=e.resolve(process.cwd(),d.entry);if(!f(t))return void a("packConfig.entry is not a available path");const i=e.join(s,"./h5pack-native/public/webview/dist");await h(t,i)}catch(e){a(e.message||"packConfig.entry is not a available path")}}async function P(s){const a=e.join(s,"./h5pack-native");l.start("ðŸš© Download Source ......"),await b(s,"git",["clone",g[d.registry],a],(e=>{throw l.stop(),new O(y,e)})),l.succeed("âœ… download success!"),await N(s,(e=>{throw new O(A,e)})),l.start("ðŸš© Handle Custom Permission ......"),await async function(){const e=d.nativePermission;if(!e)return void l.info("âœ… æ— ç‰¹æ®Šæƒé™é…ç½® ......");if(!Array.isArray(e))throw l.stop(),new O(k,e);if(Array.isArray(e)&&!e.every((e=>$.includes(e))))throw l.stop(),new O(k,JSON.stringify(e));const s=[...new Set(e)];for(const e of s)"CAMERA"===e&&await M()}(),l.start("ðŸš© Install Dependencies ......"),await b(a,"yarn",[],(e=>{throw l.stop(),new O(y,e)})),l.succeed("âœ… Dependencies Installed!"),l.start("ðŸš© Handle Custom Config ......"),await _(a),l.succeed("âœ… Handle Success!"),l.start("ðŸ˜Š Building App ......"),await b(a,"yarn",["release"],(e=>{throw l.stop(),new O(S,e)})),l.stop(),l.start("âœ… building Success ......"),l.start("ðŸ˜Š Generate Apk ......"),await async function(s,a){try{const a=e.resolve(process.cwd(),d.output||"./");if(!f(a))throw new Error("packConfig.output is not a available path");await t.promises.copyFile(e.join(s,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),e.resolve(a,"app-release.apk"))}catch(e){a(e.message||"packConfig.output is not a available path")}}(s,(e=>{throw new O(C,e)})),l.stop(),l.succeed("ðŸŽ‰ Packaging completed !!! ðŸŽ‰")}async function I(){try{const a=s.tmpdir();exports.tempDir=e.join(a,"app-build"),await t.promises.mkdir(exports.tempDir,{recursive:!0}),await P(exports.tempDir)}catch(e){!function(e){const s=c.default();s.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),s.clear()}(e),w(exports.tempDir)}}exports.tempDir=void 0;process.on("SIGINT",(async()=>{await w(exports.tempDir),process.exit()})),exports.default=()=>{d=require(e.resolve(process.cwd(),"h5pack.json")),d.registry=d.registry||"github",I()};
