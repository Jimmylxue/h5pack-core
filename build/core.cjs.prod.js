"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),a=require("os"),s=require("fs/promises"),o=require("fs"),t=require("ora"),n=require("child_process"),r=require("chalk"),i=require("xml2js");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=c(t),l=c(r),p=c(i);let u;function m(){u=require(e.resolve(process.cwd(),"h5pack.json")),u.registry=u.registry||"github",u.buildFormat=u.buildFormat||"apk"}let w=d.default(),f=d.default();function h(e){u.log&&f.info(e)}async function g(e){try{await s.rm(e,{recursive:!0,force:!0}),w.succeed("üôà Success clear cache"),console.log("success clear data")}catch(a){w.fail(`üôà remove temp dir fail in ${e}`)}}function A(e){return o.existsSync(e)}function y(a,s){o.existsSync(s)||o.mkdirSync(s,{recursive:!0});const t=o.readdirSync(a);for(const n of t){const t=e.join(a,n),r=e.join(s,n);o.statSync(t).isDirectory()?y(t,r):o.copyFileSync(t,r)}}const v={github:"https://github.com/Jimmylxue/h5pack-native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},E={code:1e4,message:"cloneÂºÇÂ∏∏ÔºåÊ£ÄÊü•ÁΩëÁªú‰ª£ÁêÜÔºåÊàñÈÖçÁΩÆ‰∏∫ÂõΩÂÜÖ‰ª£ÁêÜ"},O={code:10001,message:"Ëé∑ÂèñÈùôÊÄÅËµÑÊ∫êÂºÇÂ∏∏ÔºåÊ£ÄÊü•h5pack.json‰∏≠entryÈÖçÁΩÆ"},k={code:10002,message:"yarn installÂºÇÂ∏∏ÔºåÊ£ÄÊü•ÁΩëÁªú‰ª£ÁêÜÔºåÊàñÈÖçÁΩÆ‰∏∫ÂõΩÂÜÖ‰ª£ÁêÜ"},C={code:10003,message:".envÊñá‰ª∂ÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠nameÈÖçÁΩÆ"},_={code:10004,message:"splashÂêØÂä®È°µÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠splashÁõ∏ÂÖ≥ÈÖçÁΩÆ"},D={code:10005,message:"release APPÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÂÆâÂçìÊâìÂåÖÁéØÂ¢É"},P={code:10006,message:"copy releaseÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠outputÈÖçÁΩÆ"},R={code:10007,message:"appLogoÂêØÂä®È°µÁîüÊàêÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠logoÁõ∏ÂÖ≥ÈÖçÁΩÆ"},S={code:10008,message:"nativePermissionÈÖçÁΩÆÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•h5pack.json‰∏≠nativePermissionÁõ∏ÂÖ≥ÈÖçÁΩÆ"},b={code:10011,message:"devÁéØÂ¢ÉÂêØÂä®ÂºÇÂ∏∏"};function I(e,a,s=[],o){return new Promise(((o,t)=>{const r=a+" "+s.join(" "),i=n.spawn(a,s,{cwd:e});i.stdout.on("data",(e=>{h(`${r} stdout: ${e}`)})),i.stderr.on("data",(e=>{h(`${r} stderr: ${e}`)})),i.on("close",(e=>{0!==e?t(new Error(`${r} exited with code ${e}`)):o(!0)}))})).catch((e=>{o?.(e.message)}))}class N extends Error{failMessage=void 0;originErrorMessage;constructor(e,a){super(),this.failMessage=e,this.originErrorMessage=a}}const $=require("properties-parser");async function j(a){if(u.splash)try{const o=e.basename(u.splash),t=e.resolve(process.cwd(),u.splash),n=e.resolve(a,`./public/splash/${o}`);if(!A(t))throw new Error("packConfig.splash is not a available path");await s.copyFile(t,n),await I(a,"yarn",["react-native","generate-bootsplash",e.resolve(a,`./public/splash/${o}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new N(_,e.message)}}async function T(a){if(u.logo)try{const o=e.basename(u.logo),t=e.resolve(process.cwd(),u.logo),n=e.resolve(a,`./public/logo/${o}`);A(t)&&(await s.copyFile(t,n),await I(a,"npx",["iconkits",`--input=./public/logo/${o}`],(e=>{throw new Error(e)})))}catch(e){throw new N(R,e.message)}}async function x(a){await async function(a){const o=`\n  APP_NAME=${u.name||"H5Pack"}\n  APP_ANDROID_VERSION=${u.versionName||"1.0.0"}\n  APP_ANDROID_VERSION_CODE=${u.versionCode||"1"}\t\n  APP_PACKAGE_NAME=${u.packageName||"com.h5pack.native"}\t\n  `;try{await s.writeFile(e.resolve(a,".env"),o,"utf-8")}catch(e){throw new N(C,e.message||"write env file error")}}(a),await j(a),await T(a),await function(a){return new Promise((async(o,t)=>{if(!(u.keystorePath&&u.storePassword&&u.keyAlias&&u.keyPassword))return void o(!0);const n=e.basename(u.keystorePath),r=e.resolve(process.cwd(),u.keystorePath);if(!A(r))throw new Error("keystorePath is not a available path");const i=e.resolve(a,"./android/app/"),c=e.resolve(i,n);await s.copyFile(r,c);const d=e.resolve(a,"./android/gradle.properties"),l=$.createEditor(d);l.set("H5PACK_APP_KEY_STORE_FILE",n),l.set("H5PACK_APP_KEY_STORE_PASSWORD",u.storePassword),l.set("H5PACK_APP_KEY_ALIAS",u.keyAlias),l.set("H5PACK_APP_KEY_PASSWORD",u.keyPassword),l.save(d,(e=>{e?(console.error("‚ùå ‰øùÂ≠òÊñá‰ª∂Êó∂Âá∫Èîô:",e),t()):(console.log("‚úÖ gradle.properties Êõ¥Êñ∞ÊàêÂäü„ÄÇ"),o(!0))}))}))}(a),w.stop(),w.succeed("‚úÖ Custom Config Success")}const M="h5pack-native/android/app/src/main/AndroidManifest.xml",H={CAMERA:["android.permission.CAMERA","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],cameraWithAudio:["android.permission.CAMERA","android.permission.RECORD_AUDIO","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],LOCATION:["android.permission.ACCESS_FINE_LOCATION","android.permission.ACCESS_COARSE_LOCATION"],microphone:["android.permission.RECORD_AUDIO"],storage:["android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],RECORD_AUDIO:["android.permission.RECORD_AUDIO"]};function F(){return e.join(exports.tempDir,M)}async function L(e){const a=o.readFileSync(F(),"utf8"),s=new p.default.Parser,t=await s.parseStringPromise(a);H[e].forEach((e=>t.manifest["uses-permission"].push({$:{"android:name":e}})));let n=new p.default.Builder({renderOpts:{pretty:!0,indent:"  "}}).buildObject(t);var r;n=n.replace(/<\?xml[^?>]*\?>\s*/i,""),r=n,o.writeFileSync(F(),r,"utf8")}async function q(){await L("CAMERA"),w.succeed("‚úÖ Handle Native Permission CAMERA SUCCESS!")}async function K(){await L("LOCATION"),w.succeed("‚úÖ Handle Native Permission LOCATION SUCCESS!")}async function U(){await L("RECORD_AUDIO"),w.succeed("‚úÖ Handle Native Permission RECORD_AUDIO SUCCESS!")}const G=["CAMERA","LOCATION","RECORD_AUDIO"];async function J(a,s){try{const o=e.resolve(process.cwd(),u.entry);if(!A(o))return void s("packConfig.entry is not a available path");const t=e.join(a,"./h5pack-native/public/webview/dist");await y(o,t)}catch(e){s(e.message||"packConfig.entry is not a available path")}}async function W(a){const s=e.join(a,"./h5pack-native");w.start("üö© Download Source ......"),await I(a,"git",["clone",v[u.registry],s],(e=>{throw w.stop(),new N(E,e)})),w.succeed("‚úÖ download success!"),await J(a,(e=>{throw new N(O,e)})),w.start("üö© Handle Custom Permission ......"),await async function(){const e=u.nativePermission;if(!e)return void w.info("‚úÖ Êó†ÁâπÊÆäÊùÉÈôêÈÖçÁΩÆ ......");if(!Array.isArray(e))throw w.stop(),new N(S,e);if(Array.isArray(e)&&!e.every((e=>G.includes(e))))throw w.stop(),new N(S,JSON.stringify(e));const a=[...new Set(e)];for(const e of a)switch(e){case"CAMERA":await q();break;case"LOCATION":await K();break;case"RECORD_AUDIO":await U()}}(),w.start("üö© Install Dependencies ......"),await I(s,"yarn",[],(e=>{throw w.stop(),new N(k,e)})),w.succeed("‚úÖ Dependencies Installed!"),w.start("üö© Handle Custom Config ......"),await x(s),w.succeed("‚úÖ Handle Success!"),w.start("üòä Building App ......");const t="aab"===u.buildFormat?"release:aab":"release";await I(s,"yarn",[t],(e=>{throw w.stop(),new N(D,e)})),w.stop(),w.start("‚úÖ building Success ......"),w.start("üòä Generate Apk ......"),await async function(a,s){try{const s=e.resolve(process.cwd(),u.output||"./");if(!A(s))throw new Error("packConfig.output is not a available path");const t="aab"===u.buildFormat,n=t?e.join(a,"./h5pack-native/android/app/build/outputs/bundle/release/app-release.aab"):e.join(a,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),r=t?"app-release.aab":"app-release.apk";await o.promises.copyFile(n,e.resolve(s,r))}catch(e){s(e.message||"packConfig.output is not a available path")}}(a,(e=>{throw new N(P,e)})),w.stop(),w.succeed("üéâ Packaging completed !!! üéâ")}function V(e){return new Promise(((a,s)=>{n.exec(e,((e,o,t)=>{e?s(t||e.message):a(o||t)}))}))}async function X(){const a=d.default("Generating h5pack.json...").start();try{const t=e.resolve(process.cwd(),"h5pack.json");try{return await s.access(t,o.constants.F_OK),a.info("h5pack.json already exists"),void a.stop()}catch{}await s.writeFile(t,JSON.stringify({entry:"./dist",name:"H5PackApp",output:"./",registry:"github",buildFormat:"apk",packageName:"com.h5pack.native",versionName:"1.0.0",versionCode:"1",logo:"",splash:"",nativePermission:["CAMERA","LOCATION","RECORD_AUDIO"],keystorePath:"",storePassword:"",keyAlias:"",keyPassword:"",log:!1},null,2),"utf-8"),a.succeed("h5pack.json created")}catch(e){throw a.fail(e.message||"create h5pack.json failed"),e}}async function Y(a,s){const t=e.join(a,"./h5pack-native");w.start("üö© Prepare Native Source (Dev) ......"),A(t)?w.info("‚úÖ use local h5pack-native ......"):(await I(a,"git",["clone",v[u.registry],t],(e=>{throw w.stop(),new N(E,e)})),w.succeed("‚úÖ download success!")),await J(a,(e=>{throw new N(O,e)})),s.watch&&function(a){const s=e.resolve(process.cwd(),u.entry);if(A(s)){let e;w.info(`üëÄ Watching for changes in ${s} ......`),o.watch(s,{recursive:!0},(()=>{e&&clearTimeout(e),e=setTimeout((async()=>{w.start("üîÑ File changed, syncing ......"),await J(a,(e=>{w.fail(`‚ùå Sync failed: ${e}`)})),w.succeed("‚úÖ Sync success!")}),300)}))}}(a),s.start&&await async function(e){try{await I(e,"yarn",["dev:android:local"],(e=>{throw new Error(e)}))}catch(e){throw new N(b,e.message)}}(t),w.start("üö© Handle Dev Custom Config ......"),await async function(e){await j(e),await T(e),w.stop(),w.succeed("‚úÖ Dev Custom Config Success")}(t),w.succeed("‚úÖ Handle Success!"),w.start("üö© Install Dependencies ......"),await I(t,"yarn",[],(e=>{throw w.stop(),new N(k,e)})),w.succeed("‚úÖ Dependencies Installed!"),w.succeed("üéâ Dev project is ready. Open h5pack-native/android in Android Studio or cd h5pack-native && run yarn dev:android:local")}async function B(){try{const s=a.tmpdir();exports.tempDir=e.join(s,"app-build"),await o.promises.mkdir(exports.tempDir,{recursive:!0}),await W(exports.tempDir)}catch(e){!function(e){const a=d.default();a.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),a.clear()}(e),g(exports.tempDir)}}exports.tempDir=void 0;process.on("SIGINT",(async()=>{exports.tempDir&&await g(exports.tempDir),process.exit()})),exports.default=async()=>{const e=process.argv.slice(2),a=e[0];if("doctor"!==a)if("init"!==a)if("dev"!==a)m(),B();else{m();const a=e.includes("--watch"),s=e.includes("--start");await Y(process.cwd(),{watch:a,start:s})}else await X();else await async function(){console.log(l.default.bold.blue("\nüè• h5pack Environment Doctor\n"));const e=[{name:"Node.js",command:"node -v",required:!0},{name:"Git",command:"git --version",required:!0},{name:"Java (JDK)",command:"javac -version",required:!0,hint:"Install JDK 11+ and set JAVA_HOME."},{name:"Android SDK (adb)",command:"adb version",required:!1,hint:"Add Android SDK platform-tools to PATH."}];let a=!1;for(const s of e){const e=d.default(`Checking ${s.name}...`).start();try{const a=(await V(s.command)).trim().split("\n")[0];e.succeed(`${s.name}: ${l.default.green(a)}`)}catch(o){e.fail(`${s.name} check failed`),s.required?(a=!0,console.log(l.default.red(`   Error: ${o}`)),s.hint&&console.log(l.default.yellow(`   Hint: ${s.hint}`))):(console.log(l.default.gray(`   Warning: ${o}`)),s.hint&&console.log(l.default.gray(`   Hint: ${s.hint}`)))}}const s=["JAVA_HOME","ANDROID_HOME"];console.log(l.default.bold.blue("\nEnvironment Variables:"));for(const e of s)process.env[e]?console.log(`‚úÖ ${e} = ${process.env[e]}`):(console.log(`‚ùå ${e} is not set`),"ANDROID_HOME"!==e&&"JAVA_HOME"!==e||(a=!0));console.log("\n"),a?(console.log(l.default.red("‚ùå Missing environment requirements.")),process.exit(1)):console.log(l.default.green("‚úÖ Environment looks good"))}()};
