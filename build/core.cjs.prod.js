"use strict";var e=require("path"),s=require("os"),a=require("fs/promises"),t=require("fs"),o=require("child_process");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=r(require("ora"));async function i(e){try{await a.rm(e,{recursive:!0,force:!0}),console.log("success clear data")}catch(s){console.error("remove temp dir fail in ",e)}}function c(e){return t.existsSync(e)}function p(s,a){t.existsSync(a)||t.mkdirSync(a,{recursive:!0});const o=t.readdirSync(s);for(const r of o){const o=e.join(s,r),n=e.join(a,r);t.statSync(o).isDirectory()?p(o,n):t.copyFileSync(o,n)}}const l={github:"https://github.com/Jimmylxue/h5pack-native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},u={code:1e4,message:"clone异常，检查网络代理，或配置为国内代理"},d={code:10001,message:"获取静态资源异常，检查h5pack.json中entry配置"},w={code:10003,message:".env文件生成异常，请检查h5pack.json中name配置"},h={code:10004,message:"splash启动页生成异常，请检查h5pack.json中splash相关配置"},g={code:10005,message:"release APP异常，请检查安卓打包环境"},f={code:10006,message:"copy release异常，请检查h5pack.json中output配置"};let y;let m,v=n.default(),k=n.default();function b(e){y.log&&k.info(e)}function j(e,s,a=[],t){return new Promise(((t,r)=>{const n=s+" "+a.join(" "),i=o.spawn(s,a,{cwd:e});i.stdout.on("data",(e=>{b(`${n} stdout: ${e}`)})),i.stderr.on("data",(e=>{b(`${n} stderr: ${e}`)})),i.on("close",(e=>{0!==e?r(new Error(`${n} exited with code ${e}`)):t(!0)}))})).catch((e=>{t?.(e.message)}))}class $ extends Error{failMessage=void 0;originErrorMessage;constructor(e,s){super(),this.failMessage=e,this.originErrorMessage=s}}async function S(s){await async function(s){const t=`\n  APP_NAME=${y.name||"H5Pack"}\n  `;try{await a.writeFile(e.resolve(s,".env"),t,"utf-8")}catch(e){throw new $(w,e.message||"write env file error")}}(s),await async function(s){if(y.splash)try{const t=e.basename(y.splash),o=e.resolve(process.cwd(),y.splash),r=e.resolve(s,`./public/splash/${t}`);if(!c(o))throw new Error("packConfig.splash is not a available path");await a.copyFile(o,r),await j(s,"yarn",["react-native","generate-bootsplash",e.resolve(s,`./public/splash/${t}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new $(h,e.message)}}(s),v.stop(),v.succeed("✅ Custom Config Success")}async function x(s,a){try{const t=e.resolve(process.cwd(),y.entry);if(!c(t))return void a("packConfig.entry is not a available path");const o=e.join(s,"./h5pack-native/public/webview/dist");await p(t,o)}catch(e){a(e.message||"packConfig.entry is not a available path")}}async function C(s){const a=e.join(s,"./h5pack-native");v.start("🚩 Download Source ......"),await j(s,"git",["clone",l[y.registry],a],(e=>{throw v.stop(),new $(u,e)})),v.succeed("✅ download success!"),await x(s,(e=>{throw new $(d,e)})),v.start("🚩 Install Dependencies ......"),await j(a,"yarn",[],(e=>{throw v.stop(),new $(u,e)})),v.succeed("✅ Dependencies Installed!"),v.start("🚩 Handle Custom Config ......"),await S(a),v.succeed("✅ Handle Success!"),v.start("😊 Building App ......"),await j(a,"yarn",["release"],(e=>{throw v.stop(),new $(g,e)})),v.stop(),v.start("✅ building Success ......"),v.start("😊 Generate Apk ......"),await async function(s,a){try{const a=e.resolve(process.cwd(),y.output||"./");if(!c(a))throw new Error("packConfig.output is not a available path");await t.promises.copyFile(e.join(s,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),e.resolve(a,"app-release.apk"))}catch(e){a(e.message||"packConfig.output is not a available path")}}(s,(e=>{throw new $(f,e)})),v.stop(),v.succeed("🎉 Packaging completed !!! 🎉")}async function E(){try{const a=s.tmpdir();m=e.join(a,"app-build"),await t.promises.mkdir(m,{recursive:!0}),await C(m)}catch(e){!function(e){const s=n.default();s.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),s.clear()}(e),i(m)}}process.on("SIGINT",(async()=>{console.log("tempDir",m),await i(m),process.exit()})),module.exports=()=>{y=require(e.resolve(process.cwd(),"h5pack.json")),y.registry=y.registry||"github",E()};
