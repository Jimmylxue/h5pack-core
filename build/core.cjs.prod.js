"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),s=require("os"),a=require("fs/promises"),r=require("fs"),o=require("ora"),t=require("child_process"),i=require("xml2js");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=n(o),p=n(i);let l;let d=c.default(),u=c.default();function w(e){l.log&&u.info(e)}async function m(e){try{await a.rm(e,{recursive:!0,force:!0}),d.succeed("ðŸ™ˆ Success clear cache"),console.log("success clear data")}catch(s){d.fail(`ðŸ™ˆ remove temp dir fail in ${e}`)}}function A(e){return r.existsSync(e)}function f(s,a){r.existsSync(a)||r.mkdirSync(a,{recursive:!0});const o=r.readdirSync(s);for(const t of o){const o=e.join(s,t),i=e.join(a,t);r.statSync(o).isDirectory()?f(o,i):r.copyFileSync(o,i)}}const h={github:"https://github.com/Jimmylxue/h5pack-native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},y={code:1e4,message:"cloneå¼‚å¸¸ï¼Œæ£€æŸ¥ç½‘ç»œä»£ç†ï¼Œæˆ–é…ç½®ä¸ºå›½å†…ä»£ç†"},g={code:10001,message:"èŽ·å–é™æ€èµ„æºå¼‚å¸¸ï¼Œæ£€æŸ¥h5pack.jsonä¸­entryé…ç½®"},E={code:10002,message:"yarn installå¼‚å¸¸ï¼Œæ£€æŸ¥ç½‘ç»œä»£ç†ï¼Œæˆ–é…ç½®ä¸ºå›½å†…ä»£ç†"},v={code:10003,message:".envæ–‡ä»¶ç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­nameé…ç½®"},P={code:10004,message:"splashå¯åŠ¨é¡µç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­splashç›¸å…³é…ç½®"},_={code:10005,message:"release APPå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥å®‰å“æ‰“åŒ…çŽ¯å¢ƒ"},S={code:10006,message:"copy releaseå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­outputé…ç½®"},O={code:10007,message:"appLogoå¯åŠ¨é¡µç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­logoç›¸å…³é…ç½®"},R={code:10008,message:"nativePermissioné…ç½®å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­nativePermissionç›¸å…³é…ç½®"};function C(e,s,a=[],r){return new Promise(((r,o)=>{const i=s+" "+a.join(" "),n=t.spawn(s,a,{cwd:e});n.stdout.on("data",(e=>{w(`${i} stdout: ${e}`)})),n.stderr.on("data",(e=>{w(`${i} stderr: ${e}`)})),n.on("close",(e=>{0!==e?o(new Error(`${i} exited with code ${e}`)):r(!0)}))})).catch((e=>{r?.(e.message)}))}class b extends Error{failMessage=void 0;originErrorMessage;constructor(e,s){super(),this.failMessage=e,this.originErrorMessage=s}}const k=require("properties-parser");async function D(s){await async function(s){const r=`\n  APP_NAME=${l.name||"H5Pack"}\n  APP_ANDROID_VERSION=${l.APP_ANDROID_VERSION||"1.0.0"}\n  APP_ANDROID_VERSION_CODE=${l.APP_ANDROID_VERSION_CODE||"1"}\t\n  `;try{await a.writeFile(e.resolve(s,".env"),r,"utf-8")}catch(e){throw new b(v,e.message||"write env file error")}}(s),await async function(s){if(l.splash)try{const r=e.basename(l.splash),o=e.resolve(process.cwd(),l.splash),t=e.resolve(s,`./public/splash/${r}`);if(!A(o))throw new Error("packConfig.splash is not a available path");await a.copyFile(o,t),await C(s,"yarn",["react-native","generate-bootsplash",e.resolve(s,`./public/splash/${r}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new b(P,e.message)}}(s),await async function(s){if(l.logo)try{const r=e.basename(l.logo),o=e.resolve(process.cwd(),l.logo),t=e.resolve(s,`./public/logo/${r}`);A(o)&&(await a.copyFile(o,t),await C(s,"npx",["iconkits",`--input=./public/logo/${r}`],(e=>{throw new Error(e)})))}catch(e){throw new b(O,e.message)}}(s),await function(s){return new Promise((async(r,o)=>{if(!(l.keystorePath&&l.storePassword&&l.keyAlias&&l.keyPassword))return void r(!0);const t=e.basename(l.keystorePath),i=e.resolve(process.cwd(),l.keystorePath);if(!A(i))throw new Error("keystorePath is not a available path");const n=e.resolve(s,"./android/app/"),c=e.resolve(n,t);await a.copyFile(i,c);const p=e.resolve(s,"./android/gradle.properties"),d=k.createEditor(p);d.set("H5PACK_APP_KEY_STORE_FILE",t),d.set("H5PACK_APP_KEY_STORE_PASSWORD",l.storePassword),d.set("H5PACK_APP_KEY_ALIAS",l.keyAlias),d.set("H5PACK_APP_KEY_PASSWORD",l.keyPassword),d.save(p,(e=>{e?(console.error("âŒ ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™:",e),o()):(console.log("âœ… gradle.properties æ›´æ–°æˆåŠŸã€‚"),r(!0))}))}))}(s),d.stop(),d.succeed("âœ… Custom Config Success")}const I="h5pack-native/android/app/src/main/AndroidManifest.xml",N={CAMERA:["android.permission.CAMERA","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],cameraWithAudio:["android.permission.CAMERA","android.permission.RECORD_AUDIO","android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"],LOCATION:["android.permission.ACCESS_FINE_LOCATION","android.permission.ACCESS_COARSE_LOCATION"],microphone:["android.permission.RECORD_AUDIO"],storage:["android.permission.WRITE_EXTERNAL_STORAGE","android.permission.READ_EXTERNAL_STORAGE"]};function T(){return e.join(exports.tempDir,I)}async function j(e){const s=r.readFileSync(T(),"utf8"),a=new p.default.Parser,o=await a.parseStringPromise(s);N[e].forEach((e=>o.manifest["uses-permission"].push({$:{"android:name":e}})));let t=new p.default.Builder({renderOpts:{pretty:!0,indent:"  "}}).buildObject(o);var i;t=t.replace(/<\?xml[^?>]*\?>\s*/i,""),i=t,r.writeFileSync(T(),i,"utf8")}async function x(){await j("CAMERA"),d.succeed("âœ… Handle Native Permission CAMERA SUCCESS!")}async function $(){await j("LOCATION"),d.succeed("âœ… Handle Native Permission LOCATION SUCCESS!")}const M=["CAMERA","LOCATION"];async function L(s,a){try{const r=e.resolve(process.cwd(),l.entry);if(!A(r))return void a("packConfig.entry is not a available path");const o=e.join(s,"./h5pack-native/public/webview/dist");await f(r,o)}catch(e){a(e.message||"packConfig.entry is not a available path")}}async function F(s){const a=e.join(s,"./h5pack-native");d.start("ðŸš© Download Source ......"),await C(s,"git",["clone",h[l.registry],a],(e=>{throw d.stop(),new b(y,e)})),d.succeed("âœ… download success!"),await L(s,(e=>{throw new b(g,e)})),d.start("ðŸš© Handle Custom Permission ......"),await async function(){const e=l.nativePermission;if(!e)return void d.info("âœ… æ— ç‰¹æ®Šæƒé™é…ç½® ......");if(!Array.isArray(e))throw d.stop(),new b(R,e);if(Array.isArray(e)&&!e.every((e=>M.includes(e))))throw d.stop(),new b(R,JSON.stringify(e));const s=[...new Set(e)];for(const e of s)switch(e){case"CAMERA":await x();break;case"LOCATION":await $()}}(),d.start("ðŸš© Install Dependencies ......"),await C(a,"yarn",[],(e=>{throw d.stop(),new b(E,e)})),d.succeed("âœ… Dependencies Installed!"),d.start("ðŸš© Handle Custom Config ......"),await D(a),d.succeed("âœ… Handle Success!"),d.start("ðŸ˜Š Building App ......");const o="aab"===l.buildFormat?"release:aab":"release";await C(a,"yarn",[o],(e=>{throw d.stop(),new b(_,e)})),d.stop(),d.start("âœ… building Success ......"),d.start("ðŸ˜Š Generate Apk ......"),await async function(s,a){try{const a=e.resolve(process.cwd(),l.output||"./");if(!A(a))throw new Error("packConfig.output is not a available path");const o="aab"===l.buildFormat,t=o?e.join(s,"./h5pack-native/android/app/build/outputs/bundle/release/app-release.aab"):e.join(s,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),i=o?"app-release.aab":"app-release.apk";await r.promises.copyFile(t,e.resolve(a,i))}catch(e){a(e.message||"packConfig.output is not a available path")}}(s,(e=>{throw new b(S,e)})),d.stop(),d.succeed("ðŸŽ‰ Packaging completed !!! ðŸŽ‰")}async function H(){try{const a=s.tmpdir();exports.tempDir=e.join(a,"app-build"),await r.promises.mkdir(exports.tempDir,{recursive:!0}),await F(exports.tempDir)}catch(e){!function(e){const s=c.default();s.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),s.clear()}(e),m(exports.tempDir)}}exports.tempDir=void 0;process.on("SIGINT",(async()=>{await m(exports.tempDir),process.exit()})),exports.default=()=>{l=require(e.resolve(process.cwd(),"h5pack.json")),l.registry=l.registry||"github",l.buildFormat=l.buildFormat||"apk",H()};
