"use strict";var e=require("path"),s=require("os"),a=require("fs/promises"),o=require("fs"),t=require("child_process");function n(e){return o.existsSync(e)}function r(s,a){o.existsSync(a)||o.mkdirSync(a,{recursive:!0});const t=o.readdirSync(s);for(const n of t){const t=e.join(s,n),c=e.join(a,n);o.statSync(t).isDirectory()?r(t,c):o.copyFileSync(t,c)}}const c="https://github.com/Jimmylxue/h5pack-native.git",i={code:1e4,message:"clone异常，检查网络代理，或配置为国内代理"},l={code:10001,message:"获取静态资源异常，检查h5pack.json中entry配置"},p={code:10003,message:".env文件生成异常，请检查h5pack.json中name配置"},u={code:10004,message:"splash启动页生成异常，请检查h5pack.json中splash相关配置"},h={code:10005,message:"release APP异常，请检查安卓打包环境"},w={code:10006,message:"copy release异常，请检查h5pack.json中output配置"};function d(e,s,a=[],o){return new Promise(((o,n)=>{const r=s+" "+a.join(" ");console.log(`${s} ${a.join(" ")} 中...... in`,e);const c=t.spawn(s,a,{cwd:e});c.stdout.on("data",(e=>{console.log(`${r} stdout: ${e}`)})),c.stderr.on("data",(e=>{console.error(`${r} stderr: ${e}`)})),c.on("close",(e=>{0!==e?n(new Error(`${r} exited with code ${e}`)):o(!0)}))})).catch((e=>{o?.(e.message)}))}class g extends Error{failMessage=void 0;originErrorMessage;constructor(e,s){super(),this.failMessage=e,this.originErrorMessage=s}}async function y(s,o){await async function(s,o){const t=`\n  APP_NAME=${s.name||"H5Pack"}\n  `;try{await a.writeFile(e.resolve(o,".env"),t,"utf-8")}catch(e){throw new g(p,e.message||"write env file error")}}(s,o),await async function(s,o){if(s.splash)try{const t=e.basename(s.splash),r=e.resolve(process.cwd(),s.splash),c=e.resolve(o,`./public/splash/${t}`);if(!n(r))throw new Error("packConfig.splash is not a available path");await a.copyFile(r,c),console.log("splash copy Success"),await d(o,"yarn",["react-native","generate-bootsplash",e.resolve(o,`./public/splash/${t}`),"--platforms=android"],(e=>{throw new Error(e)})),console.log("splash generate Success")}catch(e){throw new g(u,e.message)}}(s,o)}async function f(s,a,o){try{const t=e.resolve(process.cwd(),s.entry);if(!n(t))return void o("packConfig.entry is not a available path");const c=e.join(a,"./h5pack-native/public/webview/dist");await r(t,c)}catch(e){o(e.message||"packConfig.entry is not a available path")}}async function m(s,a){const t=e.join(a,"./h5pack-native");await d(a,"git",["clone",c,t],(e=>{throw new g(i,e)})),await f(s,a,(e=>{throw new g(l,e)})),await d(t,"yarn",[],(e=>{throw new g(i,e)})),await y(s,t),await d(t,"yarn",["release"],(e=>{throw new g(h,e)})),await async function(s,a,t){try{const t=e.resolve(process.cwd(),s.output||"./");if(!n(t))throw new Error("packConfig.entry is not a available path");await o.promises.copyFile(e.join(a,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),t)}catch(e){t(e.message||"packConfig.output is not a available path")}}(s,a,(e=>{throw new g(w,e)})),console.log("打包完成")}let v;async function k(){let t;try{const a=s.tmpdir();t=e.join(a,"app-build"),await o.promises.mkdir(t,{recursive:!0}),console.log("build in tempDir",t),await m(v,t)}catch(e){!function(e){console.log("捕获的",e.failMessage,e.originErrorMessage)}(e),async function(e){try{await a.rm(e,{recursive:!0,force:!0}),console.log("success clear data")}catch(s){console.error("remove temp dir fail in ",e)}}(t)}}module.exports=()=>{v=require(e.resolve(process.cwd(),"h5pack.json")),k()};
